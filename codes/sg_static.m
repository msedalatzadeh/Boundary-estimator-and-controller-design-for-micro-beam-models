clear all
clc
fig=1
hp=1.055*10^-34;
c=2.2998*10^8;
e0=8.854*10^-12;
l = 17.6e-6;
h = 5*l;
w=10*l;
L=50*h
g=w;
V=2;
E = 1.44e9;
nu=0.38;
mu=E/(2*(1+nu));
rho = 1000;
A = w*h;
II = 1/12*w*h^3;
l0=l;
l1=l;
l2=l;
D1=E*II+mu*A*(2*l0^2+(8/15)*l1^2+l2^2);
D2=mu*II*(2*l0^2+(4/5)*l1^2);
%% %%%%%%% parameter %%%%%%%%%
% alpha(uu)=pi^2*hp*c*w*L^4/(240*g^5*D1)
% beta=e0*w*V^2*L^4/(2*g^3*D1)*10^5
% gama=0.65*g/w
% zeta=D2/D1/L^2
for uu=1:30
    uu
alpha(uu)=0.1*uu
beta=0
gama=0
mu=0
zeta=0
kf=0
km=0
nr=40
smax=1
dt=10^-4
n=3
Le = 1/n;
%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
K1=(1/Le^3)*[120/7 60*Le/7 (3*Le^2)/7 -120/7 60*Le/7 -3*Le^2/7
    60*Le/7 192*Le^2/35 11*Le^3/35 -60*Le/7 108*Le^2/35 -4*Le^3/35
    (3*Le^2)/7 11*Le^3/35 (3*Le^4)/35 -(3*Le^2)/7 (4*Le^3)/35 Le^4/70
    -120/7 -60*Le/7 -(3*Le^2)/7 120/7 -60*Le/7 (3*Le^2)/7
    60*Le/7 108*Le^2/35 (4*Le^3)/35 -60*Le/7 (192*Le^2)/35 (-11*Le^3)/35
    -3*Le^2/7 -4*Le^3/35 Le^4/70 (3*Le^2)/7 (-11*Le^3)/35 (3*Le^4)/35];

K2=(zeta/(Le^5))*[720, 360*Le, 60*Le^2, -720, 360*Le, -60*Le^2
    360*Le, 192*Le^2, 36*Le^3, -360*Le, 168*Le^2, -24*Le^3
    60*Le^2, 36*Le^3, 9*Le^4, -60*Le^2, 24*Le^3, -3*Le^4
    -720, -360*Le, -60*Le^2, 720, -360*Le, 60*Le^2
    360*Le, 168*Le^2, 24*Le^3, -360*Le, 192*Le^2, -36*Le^3
    -60*Le^2, -24*Le^3, -3*Le^4,  60*Le^2, -36*Le^3, 9*Le^4];


K=K1+K2;
%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
M = Le/55440*[21720 3732*Le 281*Le^2 6000 -1812*Le 181*Le^2
    3732*Le 832*Le^2 69*Le^3 1812*Le -532*Le^2 52*Le^3
    281*Le^2 69*Le^3 6*Le^4 181*Le^2 -52*Le^3 5*Le^4
    6000 1812*Le 181*Le^2 21720 -3732*Le 281*Le^2
    -1812*Le -532*Le^2 -52*Le^3 -3732*Le 832*Le^2 -69*Le^3
    181*Le^2 52*Le^3 5*Le^4 281*Le^2 -69*Le^3 6*Le^4];
%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
q1=.5*dt;
q2=(1-.5)*dt;
q3=1/(4/5)/dt^2;
q4=q3*dt;
q5=1/(8/5)-1;
q6=.5/(4/5*dt);
q7=.5/(4/5);
q8=dt*(.5/(8/5)-1);
%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
H{1}=[-6 15 -10 0 0 1];
H{2}=Le*[-3 8 -6 0 1 0];
H{3}=0.5*Le^2*[-1 3 -3 1 0 0];
H{4}=[6 -15 10 0 0 0];
H{5}=Le*[-3 7 -4 0 0 0];
H{6}=0.5*Le^2*[1 -2 1 0 0 0];
%% %%%%%%%%%%%%%  initial cond.   %%%%%%%%%%%%%%%%%%%%%%%%
a{1,nr}=[];
ic=[1 0 0]';
for ff=1:n+1
    a{1,nr}=[ic;a{1,nr}];
end
%%% means that :   a{1,nr}=[1,0,0,1,0,0,.....]';
at{1}=zeros(3*(n+1),1);
%% %%%%%%%%%%%%%%%%%%  assembly  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
KG=0;
MG=0;

for qq=1:n
    KK(:,:,qq)=zeros((n+1)*3);
    MM(:,:,qq)=zeros((n+1)*3);
 
 for i=1:6
     for j=1:6
         KK(i+(qq-1)*3,j+(qq-1)*3,qq)=K(i,j);
         MM(i+(qq-1)*3,j+(qq-1)*3,qq)=M(i,j);
              
     end
 end

 KG=KG+KK(:,:,qq);
 MG=MG+MM(:,:,qq);
 
end

F1=-KG(:,1);
%% %%%%%%%%%%%%%%%%%%%%% initial force & acceleration  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% % F0=zeros((n+1)*3,1);
% % for qq=1:n
% %   F0(1+(qq-1)*3:6+(qq-1)*3,1)=F0(1+(qq-1)*3:6+(qq-1)*3,1)+integralhandle(a{1,nr}(1+(qq-1)*3:6+(qq-1)*3)',alpha(uu),mu,beta,gama,Le,1000);
% % end
% % att{1}=[0;0;0;MG(4:3*(n+1),4:3*(n+1))\(-F0(4:3*(n+1))-KG(4:3*(n+1),4:3*(n+1))*a{1,nr}(4:3*(n+1)))];
%% %%%%%%%%%%%%%%%%%%%%%%%%  damping  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
CG = zeros(3*(n+1));
CG(3*n+1,3*n+1)=kf;
CG(3*n+2,3*n+2)=km;
%% %%%%%%%%%%%%  function handle %%%%%%%%%%%%
% h1=@(S)(1-10*S.^3+15*S.^4-6*S.^5);
% h2=@(S)(Le*(S-6*S.^3+8*S.^4-3*S.^5));
% h3=@(S)(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5));
% h4=@(S)(10*S.^3-15*S.^4+6*S.^5);
% h5=@(S)(Le*(-4*S.^3+7*S.^4-3*S.^5));
% h6=@(S)(Le^2/2*(S.^3-2*S.^4+S.^5));
%% %%%%%%%%%%%%%%%% static deflection %%%%%%%%%%%%%%%%%%%%%%%%%%%%
MG=zeros(3*(n+1),3*(n+1));
at{1}=zeros(3*(n+1),1);
att{1}=zeros(3*(n+1),1);
%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Khat=KG+q3*MG+q6*CG;
for s=1:smax
    s
    a{s+1,1}=a{s,nr};
    for r=1:nr
INT=zeros((n+1)*3);
Fn=zeros((n+1)*3,1);
for qq=1:n
   int=integraltan(a{s+1,r}(1+(qq-1)*3:6+(qq-1)*3)',alpha(uu),mu,beta,gama,Le,100);
   Fn(1+(qq-1)*3:6+(qq-1)*3,1)=Fn(1+(qq-1)*3:6+(qq-1)*3,1)+integralhandle(a{s+1,r}(1+(qq-1)*3:6+(qq-1)*3)',alpha(uu),mu,beta,gama,Le,100);
   INT(1+(qq-1)*3:6+(qq-1)*3,1+(qq-1)*3:6+(qq-1)*3)=INT(1+(qq-1)*3:6+(qq-1)*3,1+(qq-1)*3:6+(qq-1)*3)+int;     
 end
TG{s+1,r}=Khat-INT;

%%%%%%%%%%%%%%%%%%%% for function handle  %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Fn(1,1)=quad(@(S)(beta*gama./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5)))+beta./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^2+alpha(uu)./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^4).*(1-10*S.^3+15*S.^4-6*S.^5),0,1);
% %%%%%%%%%%%
% Fn(2,1)=quad(@(S)(beta*gama./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5)))+beta./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^2+alpha(uu)./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^4).*(Le*(S-6*S.^3+8*S.^4-3*S.^5)),0,1);
% %%%%%%%%%%%
% Fn(3,1)=quad(@(S)(beta*gama./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5)))+beta./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^2+alpha(uu)./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^4).*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5)),0,1);
% %%%%%%%%%%%
% Fn(4,1)=quad(@(S)(beta*gama./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5)))+beta./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^2+alpha(uu)./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^4).*(10*S.^3-15*S.^4+6*S.^5),0,1);
% %%%%%%%%%%%
% Fn(5,1)=quad(@(S)(beta*gama./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5)))+beta./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^2+alpha(uu)./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^4).*(Le*(-4*S.^3+7*S.^4-3*S.^5)),0,1);
% %%%%%%%%%%%
% Fn(6,1)=quad(@(S)(beta*gama./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5)))+beta./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^2+alpha(uu)./(a{s,r}(1)*(1-10*S.^3+15*S.^4-6*S.^5)+a{s,r}(2)*(Le*(S-6*S.^3+8*S.^4-3*S.^5))+a{s,r}(3)*(Le^2/2*(S.^2-3*S.^3+3*S.^4-S.^5))+a{s,r}(4)*(10*S.^3-15*S.^4+6*S.^5)+a{s,r}(5)*(Le*(-4*S.^3+7*S.^4-3*S.^5))+a{s,r}(6)*(Le^2/2*(S.^3-2*S.^4+S.^5))).^4).*(Le^2/2*(S.^3-2*S.^4+S.^5)),0,1);
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

fhat{s+1,r}=F1(4:3*(n+1))-Fn(4:3*(n+1))+MG(4:3*(n+1),4:3*(n+1))*(q3*a{s,nr}(4:3*(n+1),1)+q4*at{s}(4:3*(n+1),1)+q5*att{s}(4:3*(n+1),1))+CG(4:3*(n+1),4:3*(n+1))*(q6*a{s,nr}(4:3*(n+1),1)+q7*at{s}(4:3*(n+1),1)+q8*att{s}(4:3*(n+1),1));
da=-TG{s+1,r}(4:3*(n+1),4:3*(n+1))\(Khat(4:3*(n+1),4:3*(n+1))*a{s+1,r}(4:3*(n+1))-fhat{s+1,r});

a{s+1,r+1}(4:3*(n+1),1)=a{s+1,r}(4:3*(n+1),1)+da;
a{s+1,r+1}(1:3)=[1 0 0]';


% inv(TG{s+1,r})
% a{s+1,r}
% da
% pause(1)


% Z{s,r}=H{1}*a{s,r}(1)+H{2}*a{s,r}(2)+H{3}*a{s,r}(3)+H{4}*a{s,r}(4)+H{5}*a{s,r}(5)+H{6}*a{s,r}(6);
    end
att{s+1}=q3*(a{s+1,nr}-a{s,nr})-q4*at{s}-q5*att{s};
at{s+1}=at{s}+q2*att{s}+q1*att{s+1};
end
%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
t=0:dt:s*dt;
x=0:Le/20:Le;
% for i=1:s
%     z(:,i)=polyval(Z{i,r},x);
% end
% surf(t(1:s),x,z,'FaceColor','interp','EdgeColor','none','FaceLighting','phong')
% set(gca,'YDir','rev')

for i=1:smax+1
aaa(i)=a{i,nr}(3*n+1);
end
def(uu)=aaa(smax+1);


% % % % h=figure(fig);
% % % % plot(t(1:smax+1),aaa)
% % % % title(sprintf('alpha(uu)=%g beta=%g gama=%g zeta=%g kf=%g  km=%g',alpha(uu),beta,gama,zeta,kf,km))
% % % % xlabel('t-normalized time')
% % % % ylabel('Z-normaized distance from ground')
% % % % fig=fig+1;
end
plot(alpha,def)





% test2%%%%%%%%%%%
% omega2 = inv(M)*s;
% w1 = omega2(1,1)^0.5
% omega2 = eig(s,M);
% w1_non_cl = omega2(1)^0.5
% w1_cl = 3.516/L^2

%% PDF 1 %%%%%
% a=pi^2*hp*c*w*L/(384*E*II/L^3)/g^5
% b=e0*w*L*V^2/(384*E*II/L^3)/g^3
% upi=2/3+9*a/640
% bpi=(240*upi^4*(1-upi)-a)/120/upi^2
